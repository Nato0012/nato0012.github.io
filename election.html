<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election HQ</title>
    <link rel="stylesheet" href="global.css">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=2">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=2">
    <style>
        .election-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .results {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .party {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 10px;
        }
        .democrat {
            background-color: #3498db20;
            border: 2px solid #3498db;
        }
        .republican {
            background-color: #e74c3c20;
            border: 2px solid #e74c3c;
        }
        .percentage {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .democrat .percentage {
            color: #3498db;
        }
        .republican .percentage {
            color: #e74c3c;
        }
        .turnout {
            text-align: center;
            font-size: 1.2em;
            margin: 15px 0;
        }
        .time-info {
            text-align: center;
            margin: 15px 0;
            font-size: 1.1em;
        }
        .status {
            text-align: center;
            font-weight: bold;
            font-size: 1.3em;
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .leading-dem {
            background-color: #3498db20;
            color: #3498db;
        }
        .leading-rep {
            background-color: #e74c3c20;
            color: #e74c3c;
        }
        .final {
            background-color: #2ecc7120;
            color: #27ae60;
            font-size: 1.5em;
        }
        .history {
            margin-top: 30px;
        }
        .history h3 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .history-item {
            background-color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
        }
        button:hover {
            background-color: #2980b9;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            border: 1px solid #444;
        }
        #debug-content div {
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        #debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div class="election-container">
        <h1>Pennsylvania Election Simulator</h1>
        <div class="status" id="status">Initializing...</div>
        <div class="results">
            <div class="party democrat">
                <h2>Democrat</h2>
                <div class="percentage" id="dem-percent">--%</div>
                <div id="dem-moe">MOE: ±--%</div>
            </div>
            <div class="party republican">
                <h2>Republican</h2>
                <div class="percentage" id="rep-percent">--%</div>
                <div id="rep-moe">MOE: ±--%</div>
            </div>
        </div>
        <div class="turnout">
            <div>Turnout: <span id="turnout">--</span>% of eligible voters</div>
        </div>
        <div class="time-info">
            <div>Time remaining: <span id="time-remaining">--:--</span></div>
            <div>Next update at: <span id="next-update">--:--</span> EST</div>
        </div>
        <div class="controls">
            <button id="manual-update">Force Update Now</button>
        </div>
    </div>
    <div class="election-container history">
        <h3>Previous Updates</h3>
        <div id="history-list"></div>
    </div>
    <div id="debug-info">
        <h3 style="margin-top:0;">Debug Console</h3>
        <div id="debug-content"></div>
    </div>
    <button id="debug-toggle" onclick="document.getElementById('debug-info').style.display='none'">Hide Debug</button>

    <script>
        function logStatus(msg) {
            const debugEl = document.getElementById('debug-content');
            if (debugEl) {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                debugEl.appendChild(entry);
                debugEl.scrollTop = debugEl.scrollHeight;
            }
            console.log(msg);
        }
        
        document.getElementById('debug-info').style.display = 'block';
        logStatus("Application starting...");
        
        const electionState = {
            active: false,
            startTime: null,
            endTime: null,
            trueResults: null,
            currentResults: null,
            history: [],
            updateInterval: null,
            nextUpdateTime: null,
            credentials: {
                jsonBinKey: null,
                blocsBin: null,
                donorId: null
            }
        };
        
        const statusEl = document.getElementById('status');
        const demPercentEl = document.getElementById('dem-percent');
        const repPercentEl = document.getElementById('rep-percent');
        const demMoeEl = document.getElementById('dem-moe');
        const repMoeEl = document.getElementById('rep-moe');
        const turnoutEl = document.getElementById('turnout');
        const timeRemainingEl = document.getElementById('time-remaining');
        const nextUpdateEl = document.getElementById('next-update');
        const historyListEl = document.getElementById('history-list');
        const manualUpdateBtn = document.getElementById('manual-update');
        
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
          for (let i = 0; i < retries; i++) {
            try {
              const response = await fetch(url, options);
              if (response.status === 404 && i < retries - 1) {
                // Special handling for Vercel cold starts
                await new Promise(r => setTimeout(r, delay * (i + 1)));
                continue;
              }
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              return response;
            } catch (error) {
              if (i === retries - 1) throw error;
              await new Promise(r => setTimeout(r, delay * (i + 1)));
            }
          }
        }
        
        async function fetchEnvVars() {
            statusEl.textContent = "Loading configuration...";
            logStatus("Fetching environment variables");
            
            try {
                const response = await fetchWithRetry('/api/getEnv');
                const data = await response.json();
                
                if (!data.jsonBinKey || !data.blocsBin) {
                    throw new Error("Invalid environment variables received");
                }
                
                electionState.credentials = {
                    jsonBinKey: data.jsonBinKey,
                    blocsBin: data.blocsBin,
                    donorId: data.donorId
                };
                
                logStatus("Configuration loaded successfully");
                return true;
                
            } catch (error) {
                logStatus(`Configuration error: ${error.message}`);
                throw error;
            }
        }
        
        function calculateResults(blocs) {
            let dVotes = 0;
            let rVotes = 0;
            
            for (const bloc of blocs) {
                const dShare = (50 + bloc.base_lean) * bloc.size * bloc.turnout_factor / 100;
                const rShare = (50 - bloc.base_lean) * bloc.size * bloc.turnout_factor / 100;
                dVotes += dShare;
                rVotes += rShare;
            }
            
            const totalCast = dVotes + rVotes;
            if (totalCast === 0) {
                return { D: 0, R: 0, total_turnout: 0 };
            }
            
            return {
                D: parseFloat((dVotes / totalCast * 100).toFixed(1)),
                R: parseFloat((rVotes / totalCast * 100).toFixed(1)),
                total_turnout: parseFloat((totalCast * 100).toFixed(1))
            };
        }
        
        function applyMarginOfError(results, moePercent) {
            const moe = (Math.random() * 2 - 1) * moePercent;
            let dResult = results.D + moe;
            let rResult = results.R - moe;
            
            dResult = Math.max(0, Math.min(100, dResult));
            rResult = Math.max(0, Math.min(100, rResult));
            
            const total = dResult + rResult;
            if (total > 0) {
                dResult = parseFloat((dResult / total * 100).toFixed(1));
                rResult = parseFloat((rResult / total * 100).toFixed(1));
            }
            
            return {
                D: dResult,
                R: rResult,
                total_turnout: results.total_turnout,
                moe: parseFloat(moePercent.toFixed(1))
            };
        }
        
        function scheduleElection() {
            const now = new Date();
            const estOffset = -5 * 60 * 60 * 1000;
            const nowEST = new Date(now.getTime() + estOffset);
            
            let nextElectionStart = new Date(nowEST);
            nextElectionStart.setHours(6, 30, 0, 0);
            
            if (nowEST > nextElectionStart) {
                nextElectionStart.setDate(nextElectionStart.getDate() + 1);
            }
            
            const localStartTime = new Date(nextElectionStart.getTime() - estOffset);
            const electionEndTime = new Date(localStartTime.getTime() + (47 * 60 * 60 * 1000) + (45 * 60 * 1000));
            
            electionState.startTime = localStartTime;
            electionState.endTime = electionEndTime;
            
            if (now >= localStartTime && now <= electionEndTime) {
                startElection();
            } else {
                const timeUntilStart = localStartTime - now;
                statusEl.textContent = `Next election starts at ${formatTime(localStartTime)}`;
                setTimeout(startElection, timeUntilStart);
            }
        }
        
        function startElection() {
            electionState.active = true;
            electionState.history = [];
            electionState.currentResults = applyMarginOfError(electionState.trueResults, 2.0);
            
            updateDisplay();
            logHistoryUpdate();
            scheduleNextUpdate();
            
            statusEl.textContent = "Election in progress";
            statusEl.className = "status leading-" + (electionState.currentResults.D > electionState.currentResults.R ? "dem" : "rep");
        }
        
        function endElection() {
            electionState.active = false;
            electionState.currentResults = {
                ...electionState.trueResults,
                moe: 0.0
            };
            
            updateDisplay();
            logHistoryUpdate();
            
            statusEl.textContent = "FINAL RESULTS: " + 
                (electionState.currentResults.D > electionState.currentResults.R ? "DEMOCRAT WINS" : "REPUBLICAN WINS");
            statusEl.className = "status final";
            
            scheduleElection();
        }
        
        function scheduleNextUpdate() {
            if (!electionState.active) return;
            
            const now = new Date();
            const timeRemaining = electionState.endTime - now;
            
            if (timeRemaining <= 0) {
                endElection();
                return;
            }
            
            const minutes = now.getMinutes();
            let nextUpdate;
            
            if (timeRemaining <= 60 * 60 * 1000) {
                if (minutes < 45) {
                    if (minutes < 30) {
                        nextUpdate = new Date(now);
                        nextUpdate.setMinutes(30, 0, 0);
                    } else {
                        nextUpdate = new Date(now);
                        nextUpdate.setMinutes(45, 0, 0);
                    }
                } else {
                    nextUpdate = new Date(now);
                    nextUpdate.setHours(now.getHours() + 1);
                    nextUpdate.setMinutes(0, 0, 0);
                }
            } else {
                nextUpdate = new Date(now);
                if (minutes < 30) {
                    nextUpdate.setMinutes(30, 0, 0);
                } else {
                    nextUpdate.setHours(now.getHours() + 1);
                    nextUpdate.setMinutes(0, 0, 0);
                }
            }
            
            if (nextUpdate > electionState.endTime) {
                nextUpdate = new Date(electionState.endTime);
            }
            
            electionState.nextUpdateTime = nextUpdate;
            updateDisplay();
            
            clearTimeout(electionState.updateInterval);
            electionState.updateInterval = setTimeout(performUpdate, nextUpdate - now);
        }
        
        function performUpdate() {
            if (!electionState.active) return;
            
            const now = new Date();
            const timeRemaining = electionState.endTime - now;
            const totalElectionTime = electionState.endTime - electionState.startTime;
            const elapsedTime = now - electionState.startTime;
            const moePercent = 2.0 * (1 - elapsedTime / totalElectionTime);
            
            electionState.currentResults = applyMarginOfError(electionState.trueResults, moePercent);
            
            updateDisplay();
            logHistoryUpdate();
            
            if (now >= electionState.endTime) {
                endElection();
            } else {
                scheduleNextUpdate();
            }
        }
        
        function forceUpdate() {
            if (electionState.active) {
                performUpdate();
            }
        }
        
        function updateDisplay() {
            if (!electionState.currentResults) return;
            
            const results = electionState.currentResults;
            const isFinal = !electionState.active;
            
            demPercentEl.textContent = results.D + "%";
            repPercentEl.textContent = results.R + "%";
            demMoeEl.textContent = "MOE: ±" + results.moe + "%";
            repMoeEl.textContent = "MOE: ±" + results.moe + "%";
            turnoutEl.textContent = results.total_turnout;
            
            if (isFinal) {
                statusEl.textContent = "FINAL RESULTS: " + 
                    (results.D > results.R ? "DEMOCRAT WINS" : "REPUBLICAN WINS");
                statusEl.className = "status final";
            } else {
                statusEl.textContent = results.D > results.R ? "Democrat Leading" : "Republican Leading";
                statusEl.className = "status leading-" + (results.D > results.R ? "dem" : "rep");
            }
            
            if (electionState.active) {
                const remainingMs = electionState.endTime - new Date();
                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                timeRemainingEl.textContent = `${hours}h ${minutes}m`;
                
                if (electionState.nextUpdateTime) {
                    nextUpdateEl.textContent = formatTime(electionState.nextUpdateTime);
                }
            } else {
                timeRemainingEl.textContent = "Election ended";
                nextUpdateEl.textContent = "N/A";
            }
        }
        
        function logHistoryUpdate() {
            if (!electionState.currentResults) return;
            
            const now = new Date();
            const results = electionState.currentResults;
            const isFinal = !electionState.active;
            
            electionState.history.unshift({
                time: now,
                results: { ...results },
                isFinal: isFinal
            });
            
            renderHistory();
        }
        
        function renderHistory() {
            historyListEl.innerHTML = '';
            
            for (const item of electionState.history.slice(0, 10)) {
                const itemEl = document.createElement('div');
                itemEl.className = 'history-item';
                
                const timeStr = formatTime(item.time);
                const leader = item.results.D > item.results.R ? "DEM" : "GOP";
                const margin = Math.abs(item.results.D - item.results.R).toFixed(1);
                
                itemEl.innerHTML = `
                    <div><strong>${timeStr}</strong> ${item.isFinal ? '(FINAL)' : ''}</div>
                    <div>${leader} +${margin}% (D ${item.results.D}% - R ${item.results.R}%)</div>
                    <div>Turnout: ${item.results.total_turnout}% • MOE: ±${item.results.moe}%</div>
                `;
                
                historyListEl.appendChild(itemEl);
            }
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        function checkForUpdates() {
            if (electionState.active) {
                const now = new Date();
                if (now >= electionState.nextUpdateTime) {
                    performUpdate();
                }
            }
            
            setTimeout(checkForUpdates, 60000);
        }
        
        async function initElection() {
            statusEl.textContent = "Initializing election...";
            logStatus("Starting election initialization");
            
            try {
                statusEl.textContent = "Loading voter data...";
                logStatus(`Fetching from bin: ${electionState.credentials.blocsBin}`);
                
                const response = await fetchWithRetry(
                    `https://api.jsonbin.io/v3/b/${electionState.credentials.blocsBin}/latest`,
                    {
                        headers: { 'X-Master-Key': electionState.credentials.jsonBinKey }
                    }
                );
                
                const data = await response.json();
                logStatus("Data received, validating...");
                
                if (!data.record?.pa_voter_blocs) {
                    throw new Error("Invalid data format - missing voter blocs");
                }
                
                statusEl.textContent = "Calculating results...";
                electionState.trueResults = calculateResults(data.record.pa_voter_blocs);
                logStatus(`Base results: D ${electionState.trueResults.D}% / R ${electionState.trueResults.R}%`);
                
                statusEl.textContent = "Starting simulation...";
                scheduleElection();
                checkForUpdates();
                
                logStatus("Election simulation ready");
                statusEl.textContent = "Ready";
                statusEl.style.color = "#27ae60";
                
            } catch (error) {
                logStatus(`Initialization failed: ${error.message}`);
                statusEl.textContent = "Initialization error - see debug";
                statusEl.style.color = "#e74c3c";
                throw error;
            }
        }
        
        manualUpdateBtn.addEventListener('click', forceUpdate);
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await fetchEnvVars();
                await initElection();
            } catch (error) {
                logStatus(`Fatal error: ${error.message}`);
                if (error.stack) logStatus(error.stack);
            }
        });
    </script>
</body>
</html>
