<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Debug Mode</title>
    <link rel="stylesheet" href="/global.css?v=1.1">
    <link rel="stylesheet" href="/donors/donors.css?v=1.1">
    <style>
        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1e1e1e;
            color: #fff;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            z-index: 1000;
            border-top: 2px solid #444;
        }
        .debug-entry {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        .debug-error {
            color: #ff6b6b;
        }
        .debug-success {
            color: #6bff6b;
        }
        #debug-toggle {
            position: fixed;
            bottom: 210px;
            right: 10px;
            z-index: 1001;
            background: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="stamina-display">
        Stamina: <span id="stamina">10</span>
    </div>

    <h1>Political Donor Management - DEBUG MODE</h1>
    
    <div class="party-tabs">
        <div class="party-tab active" onclick="window.switchParty('Democrat')">Democrat Donors</div>
        <div class="party-tab" onclick="window.switchParty('Republican')">Republican Donors</div>
    </div>
    
    <div id="donor-container" class="donor-grid">
        <div class="loading-message">
            Loading donor data...
            <div id="loading-details"></div>
        </div>
    </div>

    <button id="debug-toggle" onclick="toggleDebug()">Hide Debug</button>
    <div id="debug-console">
        <div class="debug-entry">Debug console initialized...</div>
    </div>

    <script type="module">
        // Debugging utilities
        function debugLog(message, type = 'info') {
            const consoleElem = document.getElementById('debug-console');
            const entry = document.createElement('div');
            entry.className = `debug-entry debug-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleElem.appendChild(entry);
            consoleElem.scrollTop = consoleElem.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function updateLoadingMessage(message) {
            const elem = document.getElementById('loading-details');
            if (elem) elem.textContent = message;
        }

        function toggleDebug() {
            const consoleElem = document.getElementById('debug-console');
            const button = document.getElementById('debug-toggle');
            if (consoleElem.style.display === 'none') {
                consoleElem.style.display = 'block';
                button.textContent = 'Hide Debug';
            } else {
                consoleElem.style.display = 'none';
                button.textContent = 'Show Debug';
            }
        }

        // Initialize Appwrite
        debugLog("Initializing Appwrite client...");
        debugLog(`Endpoint: ${import.meta.env.VITE_APPWRITE_ENDPOINT}`);
        debugLog(`Project ID: ${import.meta.env.VITE_APPWRITE_PROJECT_ID}`);

        import { Client, Databases } from 'https://cdn.jsdelivr.net/npm/appwrite@13.0.1/+esm';

        const client = new Client()
            .setEndpoint(import.meta.env.VITE_APPWRITE_ENDPOINT)
            .setProject(import.meta.env.VITE_APPWRITE_PROJECT_ID);

        const databases = new Databases(client);

        // State management
        const state = {
            currentParty: "Democrat",
            stamina: 10,
            donors: {
                Democrat: [],
                Republican: []
            }
        };

        // Connection test
        async function testConnection() {
            updateLoadingMessage("Testing connection to Appwrite...");
            debugLog("Testing Appwrite connection");
            
            try {
                const healthResponse = await fetch(`${import.meta.env.VITE_APPWRITE_ENDPOINT}/health`, {
                    headers: {
                        'X-Appwrite-Project': import.meta.env.VITE_APPWRITE_PROJECT_ID
                    }
                });
                
                debugLog(`Health check status: ${healthResponse.status}`);
                
                if (!healthResponse.ok) {
                    throw new Error(`Health check failed with status ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                debugLog("Health check response:", healthData);
                updateLoadingMessage("Connection successful, loading donors...");
                return true;
            } catch (error) {
                debugLog(`Connection failed: ${error.message}`, 'error');
                updateLoadingMessage(`Connection failed: ${error.message}`);
                return false;
            }
        }

        // Fetch donors with detailed debugging
        async function fetchDonors() {
            debugLog("Starting donor fetch process");
            updateLoadingMessage("Preparing to fetch donor data...");
            
            // Test connection first
            const isConnected = await testConnection();
            if (!isConnected) {
                debugLog("Aborting donor fetch due to connection issues", "error");
                return;
            }

            debugLog("Fetching documents from collection...");
            updateLoadingMessage("Fetching donor records from database...");
            
            try {
                const startTime = Date.now();
                const response = await databases.listDocuments('PoliticalDonors', 'Donors');
                const fetchDuration = Date.now() - startTime;
                
                debugLog(`Fetch completed in ${fetchDuration}ms`);
                debugLog(`Received ${response.documents.length} documents`);
                updateLoadingMessage(`Found ${response.documents.length} donor records`);
                
                if (response.documents.length === 0) {
                    debugLog("No documents found in collection", "error");
                    updateLoadingMessage("No donor records found in database");
                    return;
                }

                debugLog("Processing donor documents...");
                updateLoadingMessage("Processing donor data...");
                
                state.donors = {
                    Democrat: [],
                    Republican: []
                };

                response.documents.forEach((doc, index) => {
                    debugLog(`Processing document #${index + 1}: ${doc.$id}`);
                    
                    const party = doc.party;
                    if (!party) {
                        debugLog(`Document ${doc.$id} missing party field`, "error");
                        return;
                    }

                    if (party === "Democrat" || party === "Republican") {
                        state.donors[party].push({
                            name: doc.name || "Unknown",
                            type: doc.type || "",
                            relationship: Number(doc.relationship) || 0,
                            loves: doc.loves || [],
                            hates: doc.hates || [],
                            image: doc.image || "placeholder.jpg",
                            id: doc.$id
                        });
                        debugLog(`Added ${party} donor: ${doc.name || 'Unnamed'} (${doc.$id})`);
                    } else {
                        debugLog(`Skipping document with unknown party: ${party}`, "error");
                    }
                });

                debugLog(`Processed ${state.donors.Democrat.length} Democrat donors`);
                debugLog(`Processed ${state.donors.Republican.length} Republican donors`);
                updateLoadingMessage(`Loaded ${state.donors.Democrat.length + state.donors.Republican.length} donors`);

                if (state.donors.Democrat.length === 0 && state.donors.Republican.length === 0) {
                    debugLog("No valid donors found for either party", "error");
                    updateLoadingMessage("No valid donor records found");
                }

            } catch (error) {
                debugLog(`Error fetching donors: ${error.message}`, "error");
                debugLog(`Error stack: ${error.stack}`, "error");
                updateLoadingMessage(`Error loading data: ${error.message}`);
            }
        }

        // Render donors with debug info
        function renderDonors(party) {
            debugLog(`Rendering ${party} donors...`);
            updateLoadingMessage(`Preparing ${party} donor display...`);
            
            const container = document.getElementById('donor-container');
            container.innerHTML = '';

            if (state.donors[party].length === 0) {
                debugLog(`No ${party} donors to display`, "error");
                container.innerHTML = `<div class="no-donors">No ${party} donors found</div>`;
                updateLoadingMessage(`No ${party} donors found in data`);
                return;
            }

            debugLog(`Displaying ${state.donors[party].length} ${party} donors`);
            
            state.donors[party].forEach(donor => {
                const hourly = Math.floor(500 * (1 + (donor.relationship / 10)));
                const card = document.createElement('div');
                card.className = 'donor-card';
                card.innerHTML = `
                    <img src="/images/${donor.image}" alt="${donor.name}" 
                         class="donor-image" 
                         onerror="console.error('Failed to load image: ${donor.image}'); this.src='/images/placeholder.jpg'">
                    <div class="donor-info">
                        <div class="donor-name">${donor.name}</div>
                        <div class="donor-type">${donor.type}</div>
                        <div class="donor-stats">
                            Relationship: ${donor.relationship}/100<br>
                            Hourly Donation: $${hourly.toLocaleString()}
                        </div>
                        <div class="donor-likes">
                            <strong>Loves:</strong> ${donor.loves.join(', ')}<br>
                            <strong>Hates:</strong> ${donor.hates.join(', ')}
                        </div>
                        <div class="donor-buttons">
                            <button class="btn btn-court" onclick="window.courtDonor('${party}', '${donor.id}')">
                                Court (-1 Stamina)
                            </button>
                            <button class="btn btn-attack" onclick="window.attackDonor('${party}', '${donor.id}')">
                                Attack (-2 Stamina)
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            updateLoadingMessage(`Displaying ${state.donors[party].length} ${party} donors`);
            debugLog(`Finished rendering ${party} donors`, "success");
        }

        // Initialize application
        async function init() {
            debugLog("Initializing application...");
            await fetchDonors();
            renderDonors(state.currentParty);
            updateStaminaDisplay();
            debugLog("Application initialization complete");
        }

        // Make functions available globally
        window.switchParty = function(party) {
            debugLog(`Switching to ${party} view`);
            state.currentParty = party;
            renderDonors(party);
            document.querySelectorAll('.party-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.party-tab:nth-child(${party === 'Democrat' ? 1 : 2})`).classList.add('active');
        };

        window.updateStaminaDisplay = function() {
            document.getElementById('stamina').textContent = state.stamina;
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
