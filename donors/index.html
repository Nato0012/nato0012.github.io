<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Management</title>
    <link rel="stylesheet" href="/global.css?v=1.1">
    <link rel="stylesheet" href="/donors/donors.css?v=1.1">
</head>
<body>
    <!-- Your existing HTML content -->

    <script type="module">
        // DEBUG: Verify env vars are loaded
        console.log("ENV VARS:", {
            endpoint: import.meta.env.VITE_APPWRITE_ENDPOINT,
            projectId: import.meta.env.VITE_APPWRITE_PROJECT_ID
        });

        // Force show loading error if env vars missing
        if (!import.meta.env.VITE_APPWRITE_ENDPOINT || !import.meta.env.VITE_APPWRITE_PROJECT_ID) {
            document.getElementById('donor-container').innerHTML = `
                <div class="error">
                    <h3>Configuration Error</h3>
                    <p>Missing Appwrite configuration!</p>
                    <p>Endpoint: ${import.meta.env.VITE_APPWRITE_ENDPOINT || 'NOT SET'}</p>
                    <p>Project ID: ${import.meta.env.VITE_APPWRITE_PROJECT_ID || 'NOT SET'}</p>
                </div>
            `;
            throw new Error("Appwrite config missing");
        }

        import { Client, Databases } from 'https://cdn.jsdelivr.net/npm/appwrite@13.0.1/+esm';

        // Initialize with VERIFIED env vars
        const client = new Client()
            .setEndpoint(import.meta.env.VITE_APPWRITE_ENDPOINT)
            .setProject(import.meta.env.VITE_APPWRITE_PROJECT_ID);

        const databases = new Databases(client);

        // DEBUG: Test connection immediately
        async function testConnection() {
            try {
                console.log("Testing connection to:", import.meta.env.VITE_APPWRITE_ENDPOINT);
                const response = await fetch(`${import.meta.env.VITE_APPWRITE_ENDPOINT}/health`, {
                    headers: {
                        'X-Appwrite-Project': import.meta.env.VITE_APPWRITE_PROJECT_ID
                    }
                });
                console.log("Connection test response:", response);
                return response.ok;
            } catch (error) {
                console.error("Connection test failed:", error);
                return false;
            }
        }

        // Modified fetchDonors with robust error handling
        async function fetchDonors() {
            // 1. Verify connection first
            const isConnected = await testConnection();
            if (!isConnected) {
                throw new Error("Could not connect to Appwrite");
            }

            // 2. Make VERBOSE API call
            console.log("Fetching donors from:", 'PoliticalDonors', 'Donors');
            try {
                const response = await databases.listDocuments(
                    'PoliticalDonors', 
                    'Donors'
                );
                
                console.log("API Response:", response);
                
                if (!response.documents) {
                    throw new Error("Invalid response format - missing documents");
                }
                
                return {
                    Democrat: response.documents.filter(d => d.party === "Democrat"),
                    Republican: response.documents.filter(d => d.party === "Republican")
                };
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // Initialize with error display
        async function init() {
            try {
                const donors = await fetchDonors();
                console.log("Donors loaded:", donors);
                // Render your donors here
            } catch (error) {
                console.error("Initialization failed:", error);
                document.getElementById('donor-container').innerHTML = `
                    <div class="error">
                        <h3>Data Load Failed</h3>
                        <p>${error.message}</p>
                        <p>Check console for details</p>
                    </div>
                `;
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
